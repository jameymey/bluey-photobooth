"use client";

import { useEffect, useState } from "react";
import { Button } from "@/components/ui/button";
import Link from "next/link";

const PHOTOBOOTH_FRAMES = Array.from(
  { length: 9 },
  (_, i) => `/home-page/${i + 1}.png`,
);

const PHOTOBOOTH_FRAME_INTERVAL = 200;

export default function Home() {
  const [currentFrame, setCurrentFrame] = useState(0);

  useEffect(() => {
    let frameIndex = 0;
    let direction = 1;
    let lastFrameTime = 0;
    let animationId;
    const loadedFrames = new Array(9).fill(false);
    let loadedCount = 0;

    PHOTOBOOTH_FRAMES.forEach((src, index) => {
      const img = new Image();
      img.onload = () => {
        loadedCount++;
        loadedFrames[index] = true;
        // start animation only after all frames are loaded to avoid
        // visual glitches when frames are still being fetched
        if (loadedCount === PHOTOBOOTH_FRAMES.length) {
          animationId = requestAnimationFrame(animatePhotobooth);
        }
      };
      img.onerror = () => console.error(`Failed: ${src}`);
      img.src = src;
    });

    function animatePhotobooth(timestamp) {
      if (!loadedFrames[frameIndex]) {
        animationId = requestAnimationFrame(animatePhotobooth);
        return;
      }

      if (timestamp - lastFrameTime >= PHOTOBOOTH_FRAME_INTERVAL) {
        setCurrentFrame(frameIndex);

        frameIndex += direction;
        if (frameIndex >= loadedFrames.length - 1) {
          frameIndex = loadedFrames.length - 1;
          direction = -1;
        } else if (frameIndex <= 0) {
          frameIndex = 0;
          direction = 1;
        }

        lastFrameTime = timestamp;
      }

      animationId = requestAnimationFrame(animatePhotobooth);
    }

    return () => {
      if (animationId) cancelAnimationFrame(animationId);
    };
  }, []);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen gap-8 px-4 bg-white">
      {/* PNG animation */}
      <div
        className="w-[600px] h-[600px] bg-transparent border-2 border-gray-300 rounded-lg flex items-center justify-center"
        style={{ width: 600, height: 600, margin: "0 auto" }}
      >
        <div
          aria-hidden
          className="w-full h-full"
          style={{
            backgroundImage: `url(${PHOTOBOOTH_FRAMES[currentFrame]})`,
            backgroundSize: "cover",
            backgroundPosition: "center",
            backgroundRepeat: "no-repeat",
            width: "100%",
            height: "100%",
          }}
        />
      </div>

      {/* Start Button */}
      <div style={{ display: "flex", justifyContent: "center", width: "100%" }}>
        <Link href="/layout" style={{ display: "inline-block" }}>
          <Button size="lg">Start</Button>
        </Link>
      </div>
    </div>
  );
}
